@model ResidentialHallManagement.Core.Entities.Room
@using ResidentialHallManagement.Core.Entities

@{
    ViewData["Title"] = "Room Details";
    var roomMembers = ViewBag.RoomMembers as List<ResidentialHallManagement.Core.Entities.Student> ?? new
    List<ResidentialHallManagement.Core.Entities.Student>();
    var roomAssignments = ViewBag.RoomAssignments as List<ResidentialHallManagement.Core.Entities.RoomAssignment> ?? new
    List<ResidentialHallManagement.Core.Entities.RoomAssignment>();
    var seats = ViewBag.Seats as List<Seat> ?? new List<Seat>();

    // Organize seats by position
    var windowLeftSeat = seats.FirstOrDefault(s => s.SeatType == SeatTypes.WINDOW_LEFT);
    var windowRightSeat = seats.FirstOrDefault(s => s.SeatType == SeatTypes.WINDOW_RIGHT);
    var doorLeftSeat = seats.FirstOrDefault(s => s.SeatType == SeatTypes.DOOR_LEFT);
    var doorRightSeat = seats.FirstOrDefault(s => s.SeatType == SeatTypes.DOOR_RIGHT);
}

<style>
    .room-layout-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        padding: 30px;
        position: relative;
        min-height: 450px;
        border: 3px solid #dee2e6;
    }

    .room-label {
        position: absolute;
        top: -15px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 25px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .side-label {
        position: absolute;
        background: white;
        padding: 8px 15px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
    }

    .window-label {
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: #0d6efd;
        border: 2px solid #0d6efd;
    }

    .door-label {
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: #198754;
        border: 2px solid #198754;
    }

    .seat-row {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
        padding: 15px;
    }

    .seat-card {
        width: 220px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .seat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .seat-card.booked {
        border: 3px solid #dc3545;
    }

    .seat-card.available {
        border: 3px solid #28a745;
    }

    .seat-card.pending {
        border: 3px solid #ffc107;
    }

    .seat-header {
        padding: 12px 15px;
        font-weight: bold;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .seat-header.booked {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }

    .seat-header.available {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%);
        color: white;
    }

    .seat-header.pending {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        color: #212529;
    }

    .seat-body {
        padding: 15px;
        min-height: 140px;
    }

    .student-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        margin: 0 auto 10px;
    }

    .student-info {
        text-align: center;
    }

    .student-name {
        font-weight: 600;
        font-size: 14px;
        color: #333;
        margin-bottom: 5px;
    }

    .student-id {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 3px;
    }

    .student-dept {
        font-size: 11px;
        color: #6c757d;
    }

    .empty-seat {
        text-align: center;
        padding: 20px;
    }

    .empty-seat i {
        font-size: 40px;
        color: #dee2e6;
    }

    .empty-seat p {
        color: #6c757d;
        font-size: 13px;
        margin-top: 10px;
    }

    .seat-number-badge {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    .divider-line {
        height: 2px;
        background: linear-gradient(to right, transparent, #dee2e6, transparent);
        margin: 10px 40px;
    }
</style>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-door-closed"></i> Room Details</h2>
            <p class="text-muted">@Model.Hall?.HallName - Room @(Model.RoomNumber ?? Model.RoomId)</p>
        </div>
        <div class="col-md-4 text-end">
            <a asp-action="EditRooms" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Rooms
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Room Information Card -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header text-white"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Room Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%" class="text-muted">Room ID:</th>
                            <td><strong>@Model.RoomId</strong></td>
                        </tr>
                        <tr>
                            <th class="text-muted">Room Number:</th>
                            <td>@(Model.RoomNumber ?? "N/A")</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Room Name:</th>
                            <td>@(Model.RoomName ?? "N/A")</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Block:</th>
                            <td><span class="badge bg-secondary">@(Model.Block ?? "N/A")</span></td>
                        </tr>
                        <tr>
                            <th class="text-muted">Wing:</th>
                            <td>@(Model.Wing ?? "N/A")</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Floor:</th>
                            <td>@(Model.Floor?.ToString() ?? "N/A")</td>
                        </tr>
                        <tr>
                            <th class="text-muted">Hall:</th>
                            <td><strong>@Model.Hall?.HallName</strong></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Capacity Information Card -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header text-white"
                    style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Capacity & Status</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-md-6">
                            <h6 class="text-muted">Total Capacity</h6>
                            <h3 class="text-primary">@Model.RoomCapacity</h3>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Available Slots</h6>
                            <h3 class="@(Model.AvailableSlots > 0 ? "text-success" : "text-danger")">
                                @Model.AvailableSlots</h3>
                        </div>
                    </div>
                    <hr />
                    <div class="mb-3">
                        <h6 class="text-muted">Room Status</h6>
                        @if (Model.Status == "Occupied")
                        {
                            <span class="badge bg-danger fs-6">Occupied (Full)</span>
                        }
                        else if (Model.Status == "Maintenance")
                        {
                            <span class="badge bg-warning text-dark fs-6">Under Maintenance</span>
                        }
                        else
                        {
                            <span class="badge bg-success fs-6">Available</span>
                        }
                    </div>
                    <div class="progress mt-3">
                        @{
                            var occupancyPercent = Model.RoomCapacity > 0 ? (100 - (Model.AvailableSlots * 100 /
                            Model.RoomCapacity)) : 0;
                        }
                        <div class="progress-bar @(Model.AvailableSlots > 0 ? "bg-success" : "bg-danger")"
                            role="progressbar" style="width: @occupancyPercent%">
                            @occupancyPercent% Occupied
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Room Layout with Seats -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header text-white" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
            <h5 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Room Layout - Seat Allocation</h5>
        </div>
        <div class="card-body p-4">
            @if (seats.Any())
            {
                <div class="room-layout-container">
                    <div class="room-label">
                        <i class="bi bi-door-closed"></i> Room @(Model.RoomNumber ?? Model.RoomId)
                    </div>

                    <div class="side-label window-label">
                        <i class="bi bi-window"></i> Window Side
                    </div>

                    <!-- Window Side Seats -->
                    <div class="seat-row mt-5">
                        @{
                            RenderSeatCard(windowLeftSeat, "Seat 1 - Window Left");
                        }
                        @{
                            RenderSeatCard(windowRightSeat, "Seat 2 - Window Right");
                        }
                    </div>

                    <div class="divider-line"></div>

                    <!-- Door Side Seats -->
                    <div class="seat-row mb-5">
                        @{
                            RenderSeatCard(doorLeftSeat, "Seat 3 - Door Left");
                        }
                        @{
                            RenderSeatCard(doorRightSeat, "Seat 4 - Door Right");
                        }
                    </div>

                    <div class="side-label door-label">
                        <i class="bi bi-door-open"></i> Door Side
                    </div>
                </div>

                <!-- Legend -->
                <div class="d-flex justify-content-center gap-4 mt-4">
                    <div class="d-flex align-items-center gap-2">
                        <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 4px;"></div>
                        <small class="text-muted">Booked</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div style="width: 20px; height: 20px; background: #28a745; border-radius: 4px;"></div>
                        <small class="text-muted">Available</small>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <div style="width: 20px; height: 20px; background: #ffc107; border-radius: 4px;"></div>
                        <small class="text-muted">Pending Approval</small>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle"></i> No seats have been configured for this room yet.
                </div>
            }
        </div>
    </div>
</div>

@functions {
    void RenderSeatCard(Seat? seat, string seatLabel)
    {
        var statusClass = seat?.Status switch
        {
            SeatStatuses.Booked => "booked",
            SeatStatuses.Pending or SeatStatuses.Reserved => "pending",
            _ => "available"
        };

        var student = seat?.BookedByStudent;
        var seatNumber = seat?.SeatNumber ?? 0;

        <div class="seat-card @statusClass">
            <div class="seat-header @statusClass">
                <div class="seat-number-badge">@seatNumber</div>
                <span>@seatLabel</span>
                @if (seat?.Status == SeatStatuses.Booked)
                {
                    <i class="bi bi-lock-fill ms-auto"></i>
                }
                else if (seat?.Status == SeatStatuses.Pending)
                {
                    <i class="bi bi-hourglass-split ms-auto"></i>
                }
                else
                {
                    <i class="bi bi-unlock ms-auto"></i>
                }
            </div>
            <div class="seat-body">
                @if (student != null)
                {
                    var initials = string.Join("", (student.StudentName ?? "?").Split(' ').Take(2).Select(n => n.FirstOrDefault()));
                    <div class="student-avatar">@initials</div>
                    <div class="student-info">
                        <div class="student-name">@student.StudentName</div>
                        <div class="student-id"><i class="bi bi-person-badge"></i> @student.StudentId</div>
                        <div class="student-dept"><i class="bi bi-mortarboard"></i> @(student.Department ?? student.Faculty ??
                                            "N/A")</div>
                        @if (!string.IsNullOrEmpty(student.Mobile))
                        {
                            <div class="student-dept"><i class="bi bi-telephone"></i> @student.Mobile</div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-seat">
                        @if (seat?.Status == SeatStatuses.Pending)
                        {
                            <i class="bi bi-hourglass-split text-warning"></i>
                            <p class="text-warning mb-0">Application Pending</p>
                        }
                        else
                        {
                            <i class="bi bi-person-plus"></i>
                            <p>Seat Available</p>
                        }
                    </div>
                }
            </div>
        </div>
    }
}